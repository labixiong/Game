# 俄罗斯方块游戏 {ignore=true}

[toc]

# 概述

使用技术：webpack + jquery + typescript + 面向对象开发

项目目的：

1. 学习TS如何结合webpack做开发
2. 巩固TS的知识
3. 锻炼逻辑思维能力
4. 体验面向对象编程的思想

学习方法：

1. 调整心态，不要浮躁
2. 理解->思考->实践->理解->.....

# 工程搭建

环境： 浏览器 + 模块化

webpack：构建工具，根据入口文件找寻依赖，打包

- 安装webpack
- 安装html-webpack-plugin 以某个html页面为模板
- 安装clean-webpack-plugin 打包资源生成前先清除打包目录内的文件
- 安装webpack-dev-server 启动开发服务器
- 安装ts相应的loader `ts-loader` / `awesome-typescript-loader` 它们依赖typescript

`@types/node库 要跟本地的nodejs版本保持一致，大版本保持一致即可，否则会报 node_modules/@types/node/ts4.8/test.d.ts:647:22 - error TS1005: ',' expected. 类似的错误`

# 游戏开发

原则：
1. 单一职能原则：每个类只做跟它相关的一件事
2. 开闭原则：系统中的类，应该对扩展开放，对修改关闭

基于以上两个原则，系统中使用如下模式：

数据-界面分离模式

## 开发小方块类

小方块类：它能处理自己的数据，知道什么时候需要显示，但不知道怎么显示

## 小方块的显示类

作用: 将小方块显示到页面中

文件位置：`src/core/viewer/SquarePageViewer.ts`

SquarePageViewer类来控制显示，需要给定两个属性值（需要显示的方块，以及方块展示到什么html容器中）

需要继承接口 IViewer 来实现show方法和remove方法， SquarePageViewer的实例对象给方块的显示者(viewer)赋值

## 开发方块的组合类

利用基本的方块来拼凑出各种形状的俄罗斯方块

组合类中的属性： 

- 小方块的数组

**思考：**

1. 该数组的组成能不能发生变化  

    答：不能发生变化，是只读的数组

2. 怎么组合？位置怎么定？该数组的每一项从何而来？

    答：一个方块的组合取决于组合的形状（一组相对坐标的组合，该组合中有一个特殊的坐标来表示形状的中心）

    如果知道形状、中心点和颜色，就可以设置小方块的数组

## 俄罗斯方块的生产者

文件位置: `src/core/Teris.ts`  主要用来生成随机的一个俄罗斯方块组,颜色和形状随机,传入中心点即可

## 俄罗斯方块的规则类

文件内容: `src/core/TerisRule.ts`,提供一些游戏规则

1. 不能超出面板边界
2. 旋转后的形状不能超出面板边界

## 开发旋转功能

旋转的本质：根据当前形状 -> 得到新的形状  `src/core/SquareGroup.ts 文件中 afterRotateShape方法和rotate方法`

问题: 有些方块是不旋转的(例如正方形),还有些方块旋转时是只有两种状态的

解决: rotate方法有一种通用实现方式,但是在不同情况下,会有不同的具体实现

    可以将SquareGroup类作为父类,其他的方块都是他的子类,子类可以重写父类的方法,在子类中重写rotate方法

问题：旋转后有些形状会超出边界

解决：在TerisRule类中添加rotate静态方法，如果旋转后的位置没有超出边界，则进行旋转，否则不进行旋转


## 开发游戏类

> 文件位置: `src/core/Game.ts`

游戏状态、游戏进程、游戏积分等

Game类清楚什么时候要进行显示的切换,但不知道如何显示,与方块类Square类似的问题,所以这里采用同样的处理方式

问题: 显示完之后,由于设置的中心点坐标是```{ x: 0, y: 0 }```,所以在右侧下一个方块组,有的方块组会出现超出显示范围显示到面板中

解决: 重新计算中心点坐标


## 触底处理

触底:当前方块到达最底部

什么时候可能发生触底?(即什么时候调用函数)

1. 自动下落
2. 玩家控制下落

触底之后需要做什么操作?(即函数如何编写)

1. 重新产生新的方块继续下落
2. 保存已落下的方块
3. 消除操作
4. 游戏是否结束,胜负结果

触底之后会产生新的问题?

1. 当触底后,如何保存之前已落下的方块?
2. 如何根据已保存的方块,判断当前方块是否可以移动?


